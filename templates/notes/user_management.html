{% extends "base.html" %}
{% block title %}إدارة المستخدمين{% endblock %}
{% block content %}
<div class="flex items-center justify-between mb-4">
  <h2 class="text-xl font-bold">👥 إدارة المستخدمين</h2>
  <div class="flex gap-2">
    <a href="{% url 'add_user' %}" class="bg-blue-700 text-white px-3 py-1 rounded hover:bg-blue-900">➕ إضافة مستخدم جديد</a>
    <a href="{% url 'role_change_log' %}" class="bg-yellow-600 text-white px-3 py-1 rounded hover:bg-yellow-700">سجل تغييرات الصلاحيات</a>
  </div>
</div>

<!-- إحصائيات سريعة -->
<div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
  <div class="bg-blue-100 rounded-xl p-4 text-center shadow">
    <div class="text-2xl font-bold text-blue-700">{{ total_users }}</div>
    <div class="text-sm text-blue-900 mt-2">إجمالي المستخدمين</div>
  </div>
  <div class="bg-green-100 rounded-xl p-4 text-center shadow">
    <div class="text-2xl font-bold text-green-700">{{ active_docs }}</div>
    <div class="text-sm text-green-900 mt-2">الوثائق النشطة</div>
  </div>
  <div class="bg-pink-100 rounded-xl p-4 text-center shadow">
    <div class="text-2xl font-bold text-pink-700">{{ archived_docs }}</div>
    <div class="text-sm text-pink-900 mt-2">الوثائق المؤرشفة</div>
  </div>
  <div class="bg-yellow-100 rounded-xl p-4 text-center shadow">
    <div class="text-2xl font-bold text-yellow-700">{% for r in roles_stats %}{{ r.count }} {% endfor %}</div>
    <div class="text-sm text-yellow-900 mt-2">المستخدمون حسب الدور</div>
    <div class="text-xs text-gray-600 mt-1">
      {% for r in roles_stats %}
        <span class="inline-block bg-gray-200 rounded px-2 py-1 m-1">{{ r.role }}: {{ r.count }}</span>
      {% endfor %}
    </div>
  </div>
</div>
{% if messages %}
  <ul class="mb-4">
    {% for message in messages %}
      <li style="color:{% if message.tags == 'error' %}red{% elif message.tags == 'success' %}green{% else %}#555{% endif %};font-weight:bold;">{{ message }}</li>
    {% endfor %}
  </ul>
{% endif %}
<table class="min-w-full divide-y divide-gray-200 bg-white rounded shadow">
    <thead class="bg-gray-100">
        <tr>
            <th class="px-4 py-2">اسم المستخدم</th>
            <th class="px-4 py-2">البريد الإلكتروني</th>
            <th class="px-4 py-2">الدور</th>
            <th class="px-4 py-2">إجراءات</th>
        </tr>
    </thead>
    <tbody>
        {% for item in users_with_roles %}
        <tr>
            <td class="px-4 py-2">{{ item.user.username }}</td>
            <td class="px-4 py-2">{{ item.user.email }}</td>
            <td class="px-4 py-2">
                {% if item.user != request.user %}
                    {% if item.allowed_roles %}
                        {% include "notes/roles_choices.html" with user=item.user allowed_roles=item.allowed_roles %}
                    {% else %}
                        <select class="bg-gray-100 text-gray-400 px-2 py-1 rounded" disabled>
                            <option>لا توجد رتب متاحة للتغيير</option>
                        </select>
                    {% endif %}
                {% else %}
                    <span class="text-gray-400">{{ item.user.userprofile.role }}</span>
                {% endif %}
            </td>
            <td class="px-4 py-2">
                {% if item.user != request.user %}
                <form method="post" action="{% url 'delete_user' item.user.id %}" style="display:inline;">
                    {% csrf_token %}
                    <button type="submit" class="text-red-600 hover:underline" onclick="return confirm('هل أنت متأكد من حذف هذا المستخدم؟');">حذف</button>
                </form>
                {% else %}
                <span class="text-gray-400">لا يمكن حذف نفسك</span>
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr><td colspan="4" class="text-center py-4">لا يوجد مستخدمون</td></tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}

{# إضافة زر حذف التعليق في الأخبار للمشرف فقط #}
{# مثال: في قالب عرض التعليقات في الأخبار (news_detail.html أو news.html)، أضف التالي داخل تكرار التعليقات: #}
{#
{% for comment in news.comments.all %}
  <div class="comment-box">
    <div class="comment-content">{{ comment.content }}</div>
    <div class="comment-meta">بقلم: {{ comment.user.username }}</div>
    {% if request.user.is_superuser or request.user.profile.role == 'admin' or request.user.profile.role == 'supervisor' %}
      <form method="post" action="{% url 'delete_news_comment' comment.id %}" style="display:inline;">
        {% csrf_token %}
        <button type="submit" class="text-red-600 hover:underline" onclick="return confirm('هل أنت متأكد من حذف هذا التعليق؟');">حذف التعليق</button>
      </form>
    {% endif %}
  </div>
{% endfor %}
#}
