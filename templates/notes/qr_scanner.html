{% extends "base.html" %}
{% block title %}Ù…Ø³Ø­ Ø±Ù…Ø² QR{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto py-8">
    <h2 class="text-3xl font-bold text-center mb-8 text-blue-800">
        ğŸ“± Ù…Ø³Ø­ Ø±Ù…Ø² QR Ù„Ù„ÙˆØ«Ø§Ø¦Ù‚
    </h2>
    
    <div class="bg-white rounded-xl shadow-lg p-6">
        <!-- Ø²Ø± ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
        <div class="text-center mb-6">
            <button id="startScan" 
                    class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition">
                ğŸ“· ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            </button>
            <button id="stopScan" 
                    class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition ml-4 hidden">
                â¹ï¸ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
            </button>
        </div>
        
        <!-- Ù…Ù†Ø·Ù‚Ø© Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
        <div id="qr-reader" class="mx-auto max-w-md"></div>
        
        <!-- Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
        <div id="qr-result" class="mt-6 hidden">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-green-800 mb-2">âœ… ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø±Ù…Ø² Ø¨Ù†Ø¬Ø§Ø­!</h3>
                <p class="text-green-700">Ø§Ù„Ù†ØªÙŠØ¬Ø©: <span id="qr-data" class="font-mono bg-white px-2 py-1 rounded"></span></p>
                <div class="mt-4">
                    <a id="qr-link" href="#" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition">
                        ğŸ”— ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ -->
        <div id="qr-error" class="mt-6 hidden">
            <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-red-800 mb-2">âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­</h3>
                <p class="text-red-700" id="error-message">Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹</p>
            </div>
        </div>
        
        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© -->
        <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-4">
            <h3 class="text-lg font-semibold text-blue-800 mb-3">ğŸ’¡ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…:</h3>
            <ul class="text-blue-700 space-y-2 text-sm">
                <li>â€¢ Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§" Ù„Ù„Ø¨Ø¯Ø¡</li>
                <li>â€¢ ÙˆØ¬Ù‡ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù†Ø­Ùˆ Ø±Ù…Ø² QR Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</li>
                <li>â€¢ ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¶ÙˆØ­ Ø§Ù„Ø±Ù…Ø² ÙˆØ¥Ø¶Ø§Ø¡Ø© Ø§Ù„Ù…ÙƒØ§Ù†</li>
                <li>â€¢ Ø³ÙŠØªÙ… ÙØªØ­ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³Ø­</li>
                <li>â€¢ ÙŠÙ…ÙƒÙ† Ù…Ø³Ø­ Ø±Ù…ÙˆØ² QR Ù„Ù„ÙˆØ«Ø§Ø¦Ù‚ ÙÙ‚Ø·</li>
            </ul>
        </div>
    </div>
</div>

<!-- Ù…ÙƒØªØ¨Ø© Html5-QRCode -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<script>
let html5QrcodeScanner;
let isScanning = false;

document.getElementById('startScan').addEventListener('click', function() {
    startQRScanner();
});

document.getElementById('stopScan').addEventListener('click', function() {
    stopQRScanner();
});

function startQRScanner() {
    if (isScanning) return;
    
    // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
    document.getElementById('qr-result').classList.add('hidden');
    document.getElementById('qr-error').classList.add('hidden');
    
    html5QrcodeScanner = new Html5QrcodeScanner(
        "qr-reader",
        { 
            fps: 10, 
            qrbox: { width: 250, height: 250 },
            aspectRatio: 1.0,
            showTorchButtonIfSupported: true,
            formatsToSupport: [ Html5QrcodeSupportedFormats.QR_CODE ]
        },
        false
    );
    
    html5QrcodeScanner.render(onScanSuccess, onScanFailure);
    
    isScanning = true;
    document.getElementById('startScan').classList.add('hidden');
    document.getElementById('stopScan').classList.remove('hidden');
}

function stopQRScanner() {
    if (!isScanning) return;
    
    html5QrcodeScanner.clear();
    isScanning = false;
    
    document.getElementById('startScan').classList.remove('hidden');
    document.getElementById('stopScan').classList.add('hidden');
}

function onScanSuccess(decodedText, decodedResult) {
    console.log(`ØªÙ… Ù…Ø³Ø­ Ø§Ù„ÙƒÙˆØ¯: ${decodedText}`, decodedResult);
    
    // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø³Ø­
    stopQRScanner();
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø©
    document.getElementById('qr-data').textContent = decodedText;
    document.getElementById('qr-result').classList.remove('hidden');
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ø±Ø§Ø¨Ø· Ø®Ø§Øµ Ø¨Ø§Ù„Ù…ÙˆÙ‚Ø¹
    if (decodedText.includes(window.location.hostname) || decodedText.startsWith('/')) {
        document.getElementById('qr-link').href = decodedText;
        document.getElementById('qr-link').style.display = 'inline-block';
        
        // ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 3 Ø«ÙˆØ§Ù†
        setTimeout(function() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ÙØªØ­ Ø§Ù„ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø¢Ù†ØŸ')) {
                window.location.href = decodedText;
            }
        }, 1000);
    } else {
        document.getElementById('qr-link').style.display = 'none';
        alert('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø² Ù„Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· ØµØ§Ù„Ø­ Ù„Ù„Ù…ÙˆÙ‚Ø¹');
    }
}

function onScanFailure(error) {
    // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¨Ø³ÙŠØ·Ø© Ù„Ø£Ù†Ù‡Ø§ ØªØ­Ø¯Ø« ÙƒØ«ÙŠØ±Ø§Ù‹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³Ø­
    // console.warn(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø³Ø­: ${error}`);
}

// Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¯Ø¹Ù… Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    document.getElementById('qr-error').classList.remove('hidden');
    document.getElementById('error-message').textContent = 'Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…ØªØµÙØ­';
    document.getElementById('startScan').disabled = true;
}

// Ø§Ù‡ØªØ²Ø§Ø² Ø§Ù„Ù‡Ø§ØªÙ Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ù…Ø³Ø­ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¯Ø¹ÙˆÙ…Ø§Ù‹)
function vibrate() {
    if (navigator.vibrate) {
        navigator.vibrate([200, 100, 200]);
    }
}
</script>

<style>
/* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ù…ÙƒØªØ¨Ø© QR */
#qr-reader {
    border: 2px dashed #cbd5e0;
    border-radius: 12px;
    padding: 20px;
}

#qr-reader video {
    border-radius: 8px;
}

#qr-reader canvas {
    border-radius: 8px;
}

/* Ø¥Ø®ÙØ§Ø¡ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…ÙƒØªØ¨Ø© ØºÙŠØ± Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© */
#qr-reader__dashboard_section_csr {
    display: none !important;
}

#qr-reader__header_message {
    text-align: center;
    color: #4a5568;
    font-size: 14px;
    margin-bottom: 10px;
}
</style>
{% endblock %}
