{% extends 'base.html' %}
{% load static %}

{% block title %}إنشاء وثيقة جديدة{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto bg-white p-8 mt-10 shadow-md rounded-xl">
    <!-- الشعار والعنوان -->
    <div class="text-center mb-8">
        <img src="{% static 'images/logo.png' %}" alt="شعار الاتحاد" class="w-24 mx-auto mb-2">
        <h2 class="text-2xl font-bold text-gray-800">اتحاد الصحفيين العراقيين - إنشاء وثيقة جديدة</h2>
    </div>

    <!-- رسائل الخطأ أو النجاح -->
    {% if error %}
        <div class="bg-red-100 border border-red-300 text-red-800 p-4 rounded mb-6">
            ⚠️ {{ error }}
        </div>
    {% endif %}
    {% if success %}
        <div class="bg-green-100 border border-green-300 text-green-800 p-4 rounded mb-6">
            ✅ تم إنشاء الوثيقة بنجاح.
            <a href="{% url 'download_attachment' new_note_token %}" class="text-blue-600 underline ml-2">عرض الوثيقة</a>
        </div>
    {% endif %}

    <!-- النموذج -->
    <form method="post" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}

        <div>
            <label class="block mb-1 font-medium">عنوان الوثيقة</label>
            <input type="text" name="title" required class="w-full border border-gray-300 p-2 rounded" value="{{ request.POST.title }}">
        </div>

        <div>
            <label class="block mb-1 font-medium">نوع الوثيقة</label>
            <select name="doc_type" required class="w-full border border-gray-300 p-2 rounded">
                <option value="">-- اختر النوع --</option>
                <option value="official" {% if request.POST.doc_type == 'official' %}selected{% endif %}>كتاب رسمي</option>
                <option value="administrative" {% if request.POST.doc_type == 'administrative' %}selected{% endif %}>أمر إداري</option>
                <option value="circular" {% if request.POST.doc_type == 'circular' %}selected{% endif %}>تعميم</option>
            </select>
        </div>

        <div>
            <label class="block mb-1 font-medium">الجهة المصدرة</label>
            <input type="text" name="issuer_name" required class="w-full border border-gray-300 p-2 rounded" value="{{ request.POST.issuer_name }}">
        </div>

        <div>
            <label class="block mb-1 font-medium">الجهة المستلمة</label>
            <input type="text" name="recipient_name" required class="w-full border border-gray-300 p-2 rounded" value="{{ request.POST.recipient_name }}">
        </div>

        <div>
            <label class="block mb-1 font-medium">المحتوى</label>
            <textarea name="content" rows="6" required class="w-full border border-gray-300 p-3 rounded resize-none">{{ request.POST.content }}</textarea>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
                <label class="block mb-1 font-medium">اتجاه الوثيقة</label>
                <select name="direction" class="w-full border border-gray-300 p-2 rounded">
                    <option value="outgoing" {% if request.POST.direction == 'outgoing' %}selected{% endif %}>صادرة</option>
                    <option value="incoming" {% if request.POST.direction == 'incoming' %}selected{% endif %}>واردة</option>
                </select>
            </div>

            <div>
                <label class="block mb-1 font-medium">الأهمية</label>
                <select name="importance" class="w-full border border-gray-300 p-2 rounded">
                   <option value="normal" {% if request.POST.importance == 'normal' %}selected{% endif %}>عادية</option>
                   <option value="urgent" {% if request.POST.importance == 'urgent' %}selected{% endif %}>عاجلة</option>
                   <option value="confidential" {% if request.POST.importance == 'confidential' %}selected{% endif %}>سرية</option>
                </select>
            </div>
        </div>

        <div>
            <label class="block mb-1 font-medium">تاريخ الانتهاء (اختياري)</label>
            <input type="date" name="expiry_date" class="w-full border border-gray-300 p-2 rounded" value="{{ request.POST.expiry_date }}">
        </div>

        <div>
            <label class="inline-flex items-center">
                <input type="checkbox" name="is_private" class="form-checkbox h-5 w-5 text-blue-600" {% if request.POST.is_private %}checked{% endif %}>
                <span class="ml-2 text-gray-700 font-medium">وثيقة خاصة (لن تظهر إلا لصاحبها حتى عبر QR)</span>
            </label>
        </div>

        <div>
            <label class="block mb-1 font-medium">اختر المستخدم المسموح له بالوصول (اختياري)</label>
            <select name="file_for_user" class="w-full border border-gray-300 p-2 rounded">
                <option value="">-- لا أحد --</option>
                {% for user in users %}
                    <option value="{{ user.id }}" {% if request.POST.file_for_user == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }} - {{ user.get_full_name }}</option>
                {% endfor %}
            </select>
            <small class="text-gray-500">إذا اخترت مستخدمًا، ستظهر الوثيقة فقط له (حتى لو لم يكن هو المنشئ)</small>
        </div>

        <div>
            <label class="block mb-1 font-medium">📎 مرفق (PDF / صورة)</label>
            <input type="file" name="attachment" accept=".pdf,image/*" class="w-full border border-gray-300 p-2 rounded">
        </div>

        <div>
            <label class="block mb-1 font-medium">وسوم (اختياري)</label>
            <select name="tags" multiple class="w-full border border-gray-300 p-2 rounded">
                {% for tag in tags %}
                    <option value="{{ tag.id }}" {% if tag.id|stringformat:"s" in selected_tags %}selected{% endif %}>{{ tag.name }}</option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" name="confirm" value="1" class="bg-blue-700 text-white px-6 py-2 rounded hover:bg-blue-800 transition">
            📝 إنشاء الوثيقة
        </button>
    </form>
</div>

<div class="text-sm text-gray-600 mt-8 border-t pt-4">
    ⚠️ سيتم توليد رمز تحقق (QR Code) فريد لهذه الوثيقة. يرجى مراجعة التفاصيل قبل الحفظ.
</div>
{% endblock %}
