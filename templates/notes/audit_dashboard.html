{% extends "base.html" %}
{% block title %}Ù„ÙˆØ­Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„Ø£Ù…Ø§Ù†{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-8">
    <h1 class="text-4xl font-bold text-center mb-8 text-blue-800">
        ğŸ” Ù„ÙˆØ­Ø© Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ ÙˆØ§Ù„Ø£Ù…Ø§Ù† Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
    </h1>
    
    <!-- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø© -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="card-modern text-center">
            <div class="text-3xl font-bold text-blue-600">{{ stats.total_actions_today }}</div>
            <div class="text-gray-600">Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
        <div class="card-modern text-center">
            <div class="text-3xl font-bold text-green-600">{{ stats.active_users_today }}</div>
            <div class="text-gray-600">Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø·ÙŠÙ†</div>
        </div>
        <div class="card-modern text-center">
            <div class="text-3xl font-bold text-yellow-600">{{ stats.security_alerts_today }}</div>
            <div class="text-gray-600">ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø£Ù…Ù†ÙŠØ©</div>
        </div>
        <div class="card-modern text-center">
            <div class="text-3xl font-bold text-red-600">{{ stats.failed_logins_today }}</div>
            <div class="text-gray-600">Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¯Ø®ÙˆÙ„ ÙØ§Ø´Ù„Ø©</div>
        </div>
    </div>
    
    <!-- Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="mb-6">
        <nav class="flex space-x-4 space-x-reverse">
            <button class="tab-button active" data-tab="audit-logs">Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</button>
            <button class="tab-button" data-tab="security-alerts">Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©</button>
            <button class="tab-button" data-tab="document-changes">ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</button>
            <button class="tab-button" data-tab="user-activity">Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button>
            <button class="tab-button" data-tab="reports">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
        </nav>
    </div>
    
    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    
    <!-- Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚ -->
    <div id="audit-logs" class="tab-content active">
        <div class="card-modern">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚</h2>
                <div class="flex gap-2">
                    <select id="action-filter" class="input-modern w-40">
                        <option value="">ÙƒÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª</option>
                        <option value="LOGIN">ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„</option>
                        <option value="READ">Ù‚Ø±Ø§Ø¡Ø©</option>
                        <option value="UPDATE">ØªØ­Ø¯ÙŠØ«</option>
                        <option value="DELETE">Ø­Ø°Ù</option>
                        <option value="DOWNLOAD">ØªØ­Ù…ÙŠÙ„</option>
                    </select>
                    <input type="date" id="date-filter" class="input-modern">
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="table-modern">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ÙˆÙ‚Øª</th>
                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                            <th>Ø§Ù„Ù…ÙˆØ±Ø¯</th>
                            <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø§Ù„Ø®Ø·ÙˆØ±Ø©</th>
                            <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        </tr>
                    </thead>
                    <tbody id="audit-logs-tbody">
                        {% for log in audit_logs %}
                        <tr class="{% if not log.success %}bg-red-50{% endif %}">
                            <td>{{ log.timestamp|date:"Y-m-d H:i" }}</td>
                            <td>
                                <div class="flex items-center">
                                    <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-2">
                                        {{ log.user.username|first|upper }}
                                    </div>
                                    {{ log.user.username }}
                                </div>
                            </td>
                            <td>
                                <span class="px-2 py-1 rounded text-xs font-semibold
                                    {% if log.action == 'LOGIN' %}bg-green-100 text-green-800
                                    {% elif log.action == 'DELETE' %}bg-red-100 text-red-800
                                    {% elif log.action == 'UPDATE' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-blue-100 text-blue-800{% endif %}">
                                    {{ log.get_action_display }}
                                </span>
                            </td>
                            <td>{{ log.resource_type }}</td>
                            <td>{{ log.ip_address }}</td>
                            <td>
                                {% if log.success %}
                                    <span class="text-green-600">âœ… Ù†Ø¬Ø­</span>
                                {% else %}
                                    <span class="text-red-600">âŒ ÙØ´Ù„</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="px-2 py-1 rounded text-xs font-semibold
                                    {% if log.severity == 'CRITICAL' %}bg-red-100 text-red-800
                                    {% elif log.severity == 'HIGH' %}bg-orange-100 text-orange-800
                                    {% elif log.severity == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ log.get_severity_display }}
                                </span>
                            </td>
                            <td>
                                <button class="text-blue-600 hover:underline" onclick="showLogDetails({{ log.id }})">
                                    Ø¹Ø±Ø¶
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ© -->
    <div id="security-alerts" class="tab-content">
        <div class="card-modern">
            <h2 class="text-2xl font-bold mb-4">ğŸš¨ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ù…Ù†ÙŠØ©</h2>
            
            <div class="space-y-4">
                {% for alert in security_alerts %}
                <div class="border rounded-lg p-4 
                    {% if alert.risk_level == 'CRITICAL' %}border-red-500 bg-red-50
                    {% elif alert.risk_level == 'HIGH' %}border-orange-500 bg-orange-50
                    {% elif alert.risk_level == 'MEDIUM' %}border-yellow-500 bg-yellow-50
                    {% else %}border-gray-500 bg-gray-50{% endif %}">
                    
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center mb-2">
                                <span class="px-3 py-1 rounded-full text-xs font-semibold mr-2
                                    {% if alert.risk_level == 'CRITICAL' %}bg-red-200 text-red-800
                                    {% elif alert.risk_level == 'HIGH' %}bg-orange-200 text-orange-800
                                    {% elif alert.risk_level == 'MEDIUM' %}bg-yellow-200 text-yellow-800
                                    {% else %}bg-gray-200 text-gray-800{% endif %}">
                                    {{ alert.get_risk_level_display }}
                                </span>
                                <span class="text-sm text-gray-600">{{ alert.timestamp|timesince }} Ù…Ø¶Øª</span>
                            </div>
                            
                            <h3 class="font-semibold text-lg">{{ alert.get_alert_type_display }}</h3>
                            <p class="text-gray-700 mb-2">{{ alert.description }}</p>
                            
                            <div class="text-sm text-gray-600">
                                {% if alert.user %}
                                    <span>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: {{ alert.user.username }}</span> â€¢
                                {% endif %}
                                <span>IP: {{ alert.ip_address }}</span>
                            </div>
                        </div>
                        
                        <div class="flex gap-2">
                            {% if not alert.is_resolved %}
                                <button onclick="resolveAlert({{ alert.id }})" 
                                        class="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700">
                                    Ø­Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
                                </button>
                            {% else %}
                                <span class="text-green-600 text-sm">âœ… ØªÙ… Ø§Ù„Ø­Ù„</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚ -->
    <div id="document-changes" class="tab-content">
        <div class="card-modern">
            <h2 class="text-2xl font-bold mb-4">ğŸ“„ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ÙˆØ«Ø§Ø¦Ù‚</h2>
            
            <div class="overflow-x-auto">
                <table class="table-modern">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ÙˆÙ‚Øª</th>
                            <th>Ø§Ù„ÙˆØ«ÙŠÙ‚Ø©</th>
                            <th>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                            <th>Ù†ÙˆØ¹ Ø§Ù„ØªØºÙŠÙŠØ±</th>
                            <th>Ø§Ù„Ø­Ù‚Ù„</th>
                            <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©</th>
                            <th>Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for change in document_changes %}
                        <tr>
                            <td>{{ change.timestamp|date:"Y-m-d H:i" }}</td>
                            <td>{{ change.document.title }}</td>
                            <td>{{ change.user.username }}</td>
                            <td>
                                <span class="px-2 py-1 rounded text-xs font-semibold bg-blue-100 text-blue-800">
                                    {{ change.get_change_type_display }}
                                </span>
                            </td>
                            <td>{{ change.field_name|default:"-" }}</td>
                            <td class="max-w-32 truncate">{{ change.old_value|default:"-" }}</td>
                            <td class="max-w-32 truncate">{{ change.new_value|default:"-" }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† -->
    <div id="user-activity" class="tab-content">
        <div class="card-modern">
            <h2 class="text-2xl font-bold mb-4">ğŸ‘¥ Ù†Ø´Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø§Ø·Ø§Ù‹ -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">Ø£ÙƒØ«Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù†Ø´Ø§Ø·Ø§Ù‹ Ø§Ù„ÙŠÙˆÙ…</h3>
                    <div class="space-y-2">
                        {% for user_stat in top_users %}
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                            <div class="flex items-center">
                                <div class="w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                                    {{ user_stat.user__username|first|upper }}
                                </div>
                                <span>{{ user_stat.user__username }}</span>
                            </div>
                            <span class="font-semibold">{{ user_stat.action_count }} Ø¹Ù…Ù„ÙŠØ©</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                
                <!-- Ø¹Ù†Ø§ÙˆÙŠÙ† IP Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹ -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">Ø¹Ù†Ø§ÙˆÙŠÙ† IP Ø§Ù„Ø£ÙƒØ«Ø± Ù†Ø´Ø§Ø·Ø§Ù‹</h3>
                    <div class="space-y-2">
                        {% for ip_stat in top_ips %}
                        <div class="flex justify-between items-center p-3 bg-gray-50 rounded">
                            <span class="font-mono">{{ ip_stat.ip_address }}</span>
                            <span class="font-semibold">{{ ip_stat.action_count }} Ø¹Ù…Ù„ÙŠØ©</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
    <div id="reports" class="tab-content">
        <div class="card-modern">
            <h2 class="text-2xl font-bold mb-4">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <button onclick="generateDailyReport()" class="btn-modern">
                    ğŸ“‹ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ
                </button>
                <a href="/audit/report-view/daily/" class="btn-modern" target="_blank">ï¿½ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</a>
                <a href="/audit/report-view/weekly/" class="btn-modern" target="_blank">ï¿½ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ</a>
                <a href="/audit/report-view/monthly/" class="btn-modern" target="_blank">ğŸ“ˆ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</a>
                <a href="/audit/report-view/full/" class="btn-modern" target="_blank">ğŸ”’ Ø¹Ø±Ø¶ ØªÙ‚Ø±ÙŠØ± Ø£Ù…Ù†ÙŠ Ø´Ø§Ù…Ù„</a>
                <button onclick="exportAuditLog()" class="btn-modern">
                    ğŸ’¾ ØªØµØ¯ÙŠØ± Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ù…Ù†Ø¨Ø«Ù‚Ø© Ù„ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„ -->
<div id="log-details-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 max-w-2xl w-full mx-4 max-h-96 overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-bold">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„</h3>
            <button onclick="closeLogDetails()" class="text-gray-500 hover:text-gray-700">âœ•</button>
        </div>
        <div id="log-details-content"></div>
    </div>
</div>

<script>
// Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', function() {
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† ÙƒÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
        document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
        this.classList.add('active');
        document.getElementById(this.dataset.tab).classList.add('active');
    });
});

// ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„
function showLogDetails(logId) {
    fetch(`/audit/log-details/${logId}/`)
        .then(response => response.json())
        .then(data => {
            document.getElementById('log-details-content').innerHTML = `
                <div class="space-y-3">
                    <div><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${data.timestamp}</div>
                    <div><strong>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${data.user}</div>
                    <div><strong>Ø§Ù„Ø¹Ù…Ù„ÙŠØ©:</strong> ${data.action}</div>
                    <div><strong>Ø§Ù„ÙˆØµÙ:</strong> ${data.description}</div>
                    <div><strong>Ø¹Ù†ÙˆØ§Ù† IP:</strong> ${data.ip_address}</div>
                    <div><strong>Ù…ØªØµÙØ­ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:</strong> ${data.user_agent}</div>
                    ${data.old_values ? `<div><strong>Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©:</strong> <pre class="bg-gray-100 p-2 rounded text-sm">${JSON.stringify(data.old_values, null, 2)}</pre></div>` : ''}
                    ${data.new_values ? `<div><strong>Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:</strong> <pre class="bg-gray-100 p-2 rounded text-sm">${JSON.stringify(data.new_values, null, 2)}</pre></div>` : ''}
                    ${data.error_message ? `<div><strong>Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£:</strong> <span class="text-red-600">${data.error_message}</span></div>` : ''}
                </div>
            `;
            document.getElementById('log-details-modal').classList.remove('hidden');
        });
}

function closeLogDetails() {
    document.getElementById('log-details-modal').classList.add('hidden');
}

// Ø­Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£Ù…Ù†ÙŠ
function resolveAlert(alertId) {
    if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙƒÙ…Ø­Ù„ÙˆÙ„ØŸ')) {
        fetch(`/audit/resolve-alert/${alertId}/`, {method: 'POST'})
            .then(() => location.reload());
    }
}

// Ø¥Ù†ØªØ§Ø¬ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
function generateDailyReport() {
    window.open('/audit/reports/daily/', '_blank');
}

function generateWeeklyReport() {
    window.open('/audit/reports/weekly/', '_blank');
}

function generateMonthlyReport() {
    window.open('/audit/reports/monthly/', '_blank');
}

function generateUserReport() {
    const username = prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:');
    if (username) {
        window.open(`/audit/reports/user/${username}/`, '_blank');
    }
}

function generateSecurityReport() {
    window.open('/audit/reports/security/', '_blank');
}

function exportAuditLog() {
    window.open('/audit/export/', '_blank');
}

// ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
setInterval(() => {
    if (document.getElementById('audit-logs').classList.contains('active')) {
        // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„ØªØ¯Ù‚ÙŠÙ‚
        fetch('/audit/logs-ajax/')
            .then(response => response.text())
            .then(html => {
                document.getElementById('audit-logs-tbody').innerHTML = html;
            });
    }
}, 30000);
</script>

<style>
.tab-button {
    @apply px-4 py-2 rounded-lg bg-gray-200 text-gray-700 hover:bg-gray-300 transition;
}

.tab-button.active {
    @apply bg-blue-600 text-white;
}

.tab-content {
    @apply hidden;
}

.tab-content.active {
    @apply block;
}

.table-modern tbody tr:hover {
    @apply bg-blue-50;
}
</style>
{% endblock %}
