{% extends 'notes/base.html' %}
{% load static %}

{% block title %}لوحة التحكم{% endblock %}

{% block content %}

<!-- 📱 حاوي رئيسي متجاوب للهاتف والحاسوب -->
<div id="main-wrapper" class="min-h-screen bg-gradient-to-br from-blue-50 via-white to-purple-50 dark:from-gray-900 dark:via-gray-900 dark:to-gray-800">

<!-- ✅ عنوان الصفحة محسن للهاتف -->
<div class="bg-white dark:bg-gray-900 shadow-sm border-b dark:border-gray-700 sticky top-0 z-40 mb-4 d-flex justify-content-between align-items-center">
    <div class="container mx-auto px-4 py-3 d-flex justify-content-between align-items-center">
        <h1 class="text-lg sm:text-xl md:text-2xl font-bold text-blue-900 flex items-center gap-2 mb-0">
            <span class="text-xl sm:text-2xl">📊</span>
            <span>لوحة التحكم الرئيسية</span>
        </h1>
        <!-- زر تبديل الوضع الليلي -->
        <button id="toggle-dark-mode" class="btn btn-outline-dark ms-3" title="تبديل الوضع الليلي">
            <span id="dark-mode-icon">🌙</span>
        </button>
    </div>
</div>

<!-- ✅ أزرار إدارة الوثائق - شبكة متجاوبة -->
<div class="container mx-auto px-4 mb-6">
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-2 sm:gap-3">
        <a href="{% url 'create_note' %}" class="bg-blue-600 text-white p-3 rounded-lg hover:bg-blue-700 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105">
            <div class="text-lg sm:text-xl mb-1">➕</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">إنشاء وثيقة</div>
        </a>
        <a href="{% url 'archived_notes' %}" class="bg-yellow-600 text-white p-3 rounded-lg hover:bg-yellow-700 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105">
            <div class="text-lg sm:text-xl mb-1">🗂</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">الأرشيف</div>
        </a>
        <a href="{% url 'expired_notes' %}" class="bg-red-500 text-white p-3 rounded-lg hover:bg-red-600 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105">
            <div class="text-lg sm:text-xl mb-1">📅</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">المنتهية</div>
        </a>
        <a href="{% url 'outgoing_notes' %}" class="bg-green-500 text-white p-3 rounded-lg hover:bg-green-600 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105">
            <div class="text-lg sm:text-xl mb-1">📤</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">الصادرة</div>
        </a>
        <a href="{% url 'incoming_notes' %}" class="bg-teal-500 text-white p-3 rounded-lg hover:bg-teal-600 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105">
            <div class="text-lg sm:text-xl mb-1">📥</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">الواردة</div>
        </a>
        <a href="{% url 'user_management' %}" class="bg-purple-600 text-white p-3 rounded-lg hover:bg-purple-700 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105">
            <div class="text-lg sm:text-xl mb-1">👥</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">المستخدمون</div>
        </a>
        <a href="{% url 'stats_dashboard' %}" class="bg-gray-800 text-white p-3 rounded-lg hover:bg-black transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105">
            <div class="text-lg sm:text-xl mb-1">📈</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">الإحصائيات</div>
        </a>
    </div>
</div>

<!-- 🆕 الميزات الجديدة المتقدمة - محسنة للهاتف -->
<div class="container mx-auto px-4 mb-6">
    <div class="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl shadow-sm border">
        <h2 class="text-base sm:text-lg font-bold mb-4 text-purple-800 flex items-center gap-2">
            <span class="text-lg sm:text-xl">🚀</span>
            <span>الميزات المتقدمة الجديدة</span>
        </h2>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-3">
            <!-- PWA وتطبيق الهاتف -->
            <a href="{% url 'qr_scanner' %}" class="bg-gradient-to-r from-blue-500 to-blue-600 text-white p-4 rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105">
                <div class="text-xl sm:text-2xl mb-2">📱</div>
                <div class="text-sm font-medium leading-tight">مسح QR بالهاتف</div>
            </a>
            
            <!-- نظام التدقيق المتقدم -->
            <a href="{% url 'audit_dashboard' %}" class="bg-gradient-to-r from-red-500 to-red-600 text-white p-4 rounded-lg hover:from-red-600 hover:to-red-700 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105">
                <div class="text-xl sm:text-2xl mb-2">🔍</div>
                <div class="text-sm font-medium leading-tight">لوحة التدقيق المتقدم</div>
            </a>
            
            <!-- إدارة الثيمات -->
            <button onclick="toggleThemeMenu()" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg hover:from-purple-600 hover:to-purple-700 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105 w-full">
                <div class="text-xl sm:text-2xl mb-2">🎨</div>
                <div class="text-sm font-medium leading-tight">تغيير الثيم</div>
            </button>
            
            <!-- تثبيت التطبيق -->
            <button id="installPWA" class="bg-gradient-to-r from-green-500 to-green-600 text-white p-4 rounded-lg hover:from-green-600 hover:to-green-700 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105 w-full" style="display: none;">
                <div class="text-xl sm:text-2xl mb-2">📲</div>
                <div class="text-sm font-medium leading-tight">تثبيت التطبيق</div>
            </button>
            
            <!-- إشعارات الدفع -->
            <button onclick="requestNotificationPermission()" class="bg-gradient-to-r from-orange-500 to-orange-600 text-white p-4 rounded-lg hover:from-orange-600 hover:to-orange-700 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105 w-full">
                <div class="text-xl sm:text-2xl mb-2">🔔</div>
                <div class="text-sm font-medium leading-tight">تفعيل الإشعارات</div>
            </button>
            
            <!-- فحص PWA -->
            <a href="{% url 'pwa_checker' %}" class="bg-gradient-to-r from-purple-500 to-purple-600 text-white p-4 rounded-lg hover:from-purple-600 hover:to-purple-700 transition-all duration-200 text-center shadow-sm hover:shadow-md transform hover:scale-105 w-full block">
                <div class="text-xl sm:text-2xl mb-2">🔍</div>
                <div class="text-sm font-medium leading-tight">فحص PWA</div>
            </a>
        </div>
    </div>
</div>

<!-- ✅ أزرار السجلات والأنشطة - محسنة للهاتف -->
<div class="container mx-auto px-4 mb-6">
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2 sm:gap-3">
        <a href="{% url 'search_log' %}" class="bg-gray-600 text-white p-3 rounded-lg hover:bg-gray-700 transition-all duration-200 text-center shadow-sm hover:shadow-md">
            <div class="text-lg mb-1">🔍</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">سجل البحث</div>
        </a>
        <a href="{% url 'archive_log' %}" class="bg-indigo-600 text-white p-3 rounded-lg hover:bg-indigo-700 transition-all duration-200 text-center shadow-sm hover:shadow-md">
            <div class="text-lg mb-1">🗂</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">سجل الأرشفة</div>
        </a>
        <a href="{% url 'login_history' %}" class="bg-green-800 text-white p-3 rounded-lg hover:bg-green-900 transition-all duration-200 text-center shadow-sm hover:shadow-md">
            <div class="text-lg mb-1">🕓</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">سجل الدخول</div>
        </a>
        <a href="{% url 'role_change_log' %}" class="bg-yellow-800 text-white p-3 rounded-lg hover:bg-yellow-900 transition-all duration-200 text-center shadow-sm hover:shadow-md">
            <div class="text-lg mb-1">🛠</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">تغيير الأدوار</div>
        </a>
        <a href="{% url 'activity_log' %}" class="bg-red-700 text-white p-3 rounded-lg hover:bg-red-800 transition-all duration-200 text-center shadow-sm hover:shadow-md">
            <div class="text-lg mb-1">📊</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">سجل الأنشطة</div>
        </a>
        <a href="{% url 'access_log' %}" class="bg-teal-700 text-white p-3 rounded-lg hover:bg-teal-800 transition-all duration-200 text-center shadow-sm hover:shadow-md">
            <div class="text-lg mb-1">📜</div>
            <div class="text-xs sm:text-sm font-medium leading-tight">سجل الوصول</div>
        </a>
    </div>
</div>

<!-- ✅ إحصائيات متقدمة - محسنة للهاتف -->
<div class="container mx-auto px-4 mb-8">
    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3 sm:gap-4">
        <!-- الإحصائيات الأساسية -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 text-center hover:shadow-md transition-shadow">
            <div class="text-2xl mb-2">👥</div>
            <h4 class="font-bold text-gray-700 text-sm sm:text-base">المستخدمون</h4>
            <p class="text-xl sm:text-2xl font-bold text-blue-600">{{ stats.users }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-green-100 text-center hover:shadow-md transition-shadow">
            <div class="text-2xl mb-2">📄</div>
            <h4 class="font-bold text-gray-700 text-sm sm:text-base">الوثائق النشطة</h4>
            <p class="text-xl sm:text-2xl font-bold text-green-600">{{ stats.active }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-yellow-100 text-center hover:shadow-md transition-shadow">
            <div class="text-2xl mb-2">⏰</div>
            <h4 class="font-bold text-gray-700 text-sm sm:text-base">الوثائق المنتهية</h4>
            <p class="text-xl sm:text-2xl font-bold text-yellow-600">{{ stats.expired }}</p>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-purple-100 text-center hover:shadow-md transition-shadow">
            <div class="text-2xl mb-2">🗃️</div>
            <h4 class="font-bold text-gray-700 text-sm sm:text-base">الوثائق المؤرشفة</h4>
            <p class="text-xl sm:text-2xl font-bold text-purple-600">{{ stats.archived }}</p>
        </div>
        
        <!-- 🆕 إحصائيات التدقيق المتقدم -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-red-100 text-center hover:shadow-md transition-shadow">
            <div class="text-2xl mb-2">🔍</div>
            <h4 class="font-bold text-gray-700 text-sm sm:text-base">سجلات التدقيق</h4>
            <p class="text-xl sm:text-2xl font-bold text-red-600" data-stat="audit_logs">{{ stats.audit_logs|default:0 }}</p>
            <small class="text-gray-500 text-xs">اليوم</small>
        </div>
        <div class="bg-white p-4 rounded-xl shadow-sm border border-orange-100 text-center hover:shadow-md transition-shadow">
            <div class="text-2xl mb-2">⚠️</div>
            <h4 class="font-bold text-gray-700 text-sm sm:text-base">تنبيهات الأمان</h4>
            <p class="text-xl sm:text-2xl font-bold text-orange-600" data-stat="security_alerts">{{ stats.security_alerts|default:0 }}</p>
            <small class="text-gray-500 text-xs">غير محلولة</small>
        </div>
    </div>
</div>

<!-- 🆕 لوحة التنبيهات السريعة - محسنة للهاتف -->
{% if security_alerts %}
<div class="container mx-auto px-4 mb-6">
    <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-lg shadow-sm">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
            </div>
            <div class="mr-3 flex-1">
                <h3 class="text-sm font-medium text-red-800">تنبيهات أمنية جديدة!</h3>
                <div class="mt-2 text-sm text-red-700">
                    <ul class="list-disc list-inside space-y-1">
                        {% for alert in security_alerts|slice:":3" %}
                        <li class="break-words">{{ alert.get_alert_type_display }} - {{ alert.get_risk_level_display }} ({{ alert.timestamp|timesince }})</li>
                        {% endfor %}
                    </ul>
                    {% if security_alerts|length > 3 %}
                    <p class="mt-2">
                        <a href="{% url 'audit_dashboard' %}" class="font-medium underline text-red-800 hover:text-red-600">
                            عرض جميع التنبيهات ({{ security_alerts|length }})
                        </a>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- 🆕 نشاط حديث - محسن للهاتف -->
<div class="container mx-auto px-4 mb-6">
    <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border">
        <div class="px-4 sm:px-6 py-4 border-b border-gray-200">
            <h3 class="text-base sm:text-lg font-medium text-gray-900 flex items-center gap-2">
                <span class="text-lg">📊</span>
                <span>النشاط الحديث</span>
            </h3>
        </div>
        <div class="divide-y divide-gray-200">
            {% for log in recent_audit_logs|slice:":5" %}
            <div class="px-4 sm:px-6 py-4 flex items-center space-x-3 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                <div class="flex-shrink-0">
                    {% if log.action == 'CREATE' %}
                        <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-green-100">
                            <span class="text-green-600 text-sm">➕</span>
                        </span>
                    {% elif log.action == 'UPDATE' %}
                        <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-blue-100">
                            <span class="text-blue-600 text-sm">✏️</span>
                        </span>
                    {% elif log.action == 'DELETE' %}
                        <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-red-100">
                            <span class="text-red-600 text-sm">🗑️</span>
                        </span>
                    {% elif log.action == 'LOGIN' %}
                        <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-yellow-100">
                            <span class="text-yellow-600 text-sm">🔑</span>
                        </span>
                    {% else %}
                        <span class="inline-flex items-center justify-center h-8 w-8 rounded-full bg-gray-100">
                            <span class="text-gray-600 text-sm">📝</span>
                        </span>
                    {% endif %}
                </div>
                <div class="flex-1 min-w-0">
                    <p class="text-sm font-medium text-gray-900 truncate">
                        {{ log.user.username }} - {{ log.get_action_display }}
                    </p>
                    <p class="text-xs sm:text-sm text-gray-500 truncate">
                        {{ log.resource_name|default:log.resource_type }} • {{ log.timestamp|timesince }}
                    </p>
                </div>
                <div class="flex-shrink-0">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium 
                        {% if log.severity == 'CRITICAL' %}bg-red-100 text-red-800
                        {% elif log.severity == 'HIGH' %}bg-orange-100 text-orange-800
                        {% elif log.severity == 'MEDIUM' %}bg-yellow-100 text-yellow-800
                        {% else %}bg-green-100 text-green-800{% endif %}">
                        {{ log.get_severity_display }}
                    </span>
                </div>
            </div>
            {% empty %}
            <div class="px-4 sm:px-6 py-8 text-center text-gray-500">
                <div class="text-4xl mb-2">📝</div>
                <p>لا توجد أنشطة حديثة</p>
            </div>
            {% endfor %}
        </div>
        {% if recent_audit_logs|length > 5 %}
        <div class="px-4 sm:px-6 py-3 bg-gray-50 border-t border-gray-200 rounded-b-xl">
            <a href="{% url 'audit_dashboard' %}" class="text-sm font-medium text-indigo-600 hover:text-indigo-500">
                عرض جميع الأنشطة →
            </a>
        </div>
        {% endif %}
    </div>
</div>

<!-- ✅ نموذج البحث - محسن للهاتف -->
<div class="container mx-auto px-4 mb-6">
    <form method="get" class="bg-white dark:bg-gray-900 p-4 rounded-xl shadow-sm border dark:border-gray-700">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 mb-3">
            <input type="text" name="q" placeholder="بحث بعنوان الوثيقة..." value="{{ request.GET.q|default:'' }}"
                   class="border border-gray-300 dark:border-gray-700 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white" />
            <select name="doc_type" class="border border-gray-300 dark:border-gray-700 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white">
                <option value="">كل الأنواع</option>
                <option value="official" {% if request.GET.doc_type == 'official' %}selected{% endif %}>كتاب رسمي</option>
                <option value="administrative" {% if request.GET.doc_type == 'administrative' %}selected{% endif %}>أمر إداري</option>
                <option value="circular" {% if request.GET.doc_type == 'circular' %}selected{% endif %}>تعميم</option>
            </select>
            <input type="date" name="created_at" value="{{ request.GET.created_at|default:'' }}" 
                   class="border border-gray-300 dark:border-gray-700 p-3 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent dark:bg-gray-800 dark:text-white" />
            <button type="submit" class="bg-blue-600 dark:bg-blue-800 text-white px-6 py-3 rounded-lg hover:bg-blue-700 dark:hover:bg-blue-900 transition-colors font-medium">
                🔍 بحث
            </button>
        </div>
    </form>
</div>

<!-- ✅ جدول الوثائق - محسن للهاتف -->
<div class="container mx-auto px-4 mb-6">
    <div class="bg-white dark:bg-gray-900 rounded-xl shadow-sm border dark:border-gray-700 overflow-hidden">
        <!-- عرض البطاقات للهاتف -->
        <div class="block sm:hidden">
            {% for note in notes %}
            <div class="border-b border-gray-200 dark:border-gray-700 p-4 hover:bg-gray-50 dark:hover:bg-gray-800">
                <div class="flex justify-between items-start mb-2">
                    <h3 class="font-medium text-gray-900 dark:text-white text-sm">{{ note.title|truncatechars:30 }}</h3>
                    <span class="text-xs px-2 py-1 rounded-full
                        {% if note.is_archived %}bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200
                        {% elif note.expiry_date and note.expiry_date < now %}bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200
                        {% else %}bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200{% endif %}">
                        {% if note.is_archived %}مؤرشفة
                        {% elif note.expiry_date and note.expiry_date < now %}منتهية
                        {% else %}نشطة{% endif %}
                    </span>
                </div>
                <div class="text-xs text-gray-500 dark:text-gray-300 mb-2">
                    <span>{{ note.get_doc_type_display }}</span> • 
                    <span>{{ note.created_at|date:"Y-m-d" }}</span> • 
                    <span>👁️ {{ note.access_logs.count }}</span>
                </div>
                <div class="flex flex-wrap gap-1 mb-3">
                    {% for tag in note.tags.all %}
                        <span class="bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 rounded px-2 py-1 text-xs">{{ tag.name }}</span>
                    {% empty %}
                        <span class="text-gray-400 dark:text-gray-500 text-xs">لا توجد وسوم</span>
                    {% endfor %}
                </div>
                <div class="flex flex-wrap gap-2 text-xs">
                    <a href="{% url 'download_attachment' note.access_token %}" class="text-blue-600 dark:text-blue-400 hover:underline">عرض الوثيقة</a>
                    <a href="{% url 'note_qr_only' note.access_token %}" class="text-blue-600 dark:text-blue-400 hover:underline">QR</a>
                    {% if note.file %}
                        <a href="{{ note.file.url }}" download class="text-green-600 hover:underline">تحميل</a>
                    {% endif %}
                    {% if not note.is_archived %}
                        <a href="{% url 'archive_note' note.id %}" class="text-yellow-600 hover:underline">أرشفة</a>
                    {% endif %}
                    <a href="{% url 'delete_note' note.id %}" class="text-red-600 hover:underline"
                       onclick="return confirm('هل أنت متأكد من حذف هذه الوثيقة؟')">حذف</a>
                </div>
            </div>
            {% empty %}
            <div class="text-center py-8 text-gray-500 dark:text-gray-300">
                <div class="text-4xl mb-2">📭</div>
                <p>لا توجد وثائق متاحة.</p>
            </div>
            {% endfor %}
        </div>

        <!-- عرض الجدول للشاشات الكبيرة -->
        <div class="hidden sm:block overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50 dark:bg-gray-800">
                    <tr>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">📄 العنوان</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">📂 النوع</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">📆 الإنشاء</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">🛡️ الحالة</th>
                        <th class="px-4 py-3 text-right font-medium text-gray-700">🏷 الوسوم</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">👁️ الوصول</th>
                        <th class="px-4 py-3 text-center font-medium text-gray-700">⚙️ الإجراءات</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for note in notes %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3">{{ note.title }}</td>
                        <td class="px-4 py-3">{{ note.get_doc_type_display }}</td>
                        <td class="px-4 py-3">{{ note.created_at|date:"Y-m-d" }}</td>
                        <td class="px-4 py-3">
                            {% if note.is_archived %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">مؤرشفة</span>
                            {% elif note.expiry_date and note.expiry_date < now %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">منتهية</span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">نشطة</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex flex-wrap gap-1">
                                {% for tag in note.tags.all %}
                                    <span class="bg-blue-100 text-blue-800 rounded px-2 py-1 text-xs">{{ tag.name }}</span>
                                {% empty %}
                                    <span class="text-gray-400">لا توجد</span>
                                {% endfor %}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <span class="inline-flex items-center text-sm text-gray-600">
                                👁️ {{ note.access_logs.count }}
                            </span>
                        </td>
                        <td class="px-4 py-3 text-center">
                            <div class="flex justify-center space-x-1 rtl:space-x-reverse">
                                <a href="{% url 'download_attachment' note.access_token %}" class="text-blue-600 hover:text-blue-800 text-xs">عرض الوثيقة</a>
                                <span class="text-gray-300">|</span>
                                <a href="{% url 'note_qr_only' note.access_token %}" class="text-blue-600 hover:text-blue-800 text-xs">QR</a>
                                {% if note.file %}
                                    <span class="text-gray-300">|</span>
                                    <a href="{{ note.file.url }}" download class="text-green-600 hover:text-green-800 text-xs">تحميل</a>
                                {% endif %}
                                {% if not note.is_archived %}
                                    <span class="text-gray-300">|</span>
                                    <a href="{% url 'archive_note' note.id %}" class="text-yellow-600 hover:text-yellow-800 text-xs">أرشفة</a>
                                {% endif %}
                                <span class="text-gray-300">|</span>
                                <a href="{% url 'delete_note' note.id %}" class="text-red-600 hover:text-red-800 text-xs"
                                   onclick="return confirm('هل أنت متأكد من حذف هذه الوثيقة؟')">حذف</a>
                            </div>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center text-gray-500 py-8">
                            <div class="text-4xl mb-2">📭</div>
                            <p>لا توجد وثائق متاحة.</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- زر الإشعارات مع العداد -->
<div style="position:relative;display:inline-block;margin-right:8px;">
    <a href="{% url 'notifications_center' %}" class="p-2 rounded-lg hover:bg-blue-100 transition-colors block border border-transparent hover:border-blue-300">
        <span class="text-xl text-blue-600">🔔</span>
    </a>
    <span id="notification-badge" style="position:absolute;top:-6px;right:-6px;background:#e11d48;color:#fff;font-size:12px;padding:2px 6px;border-radius:999px;display:none;min-width:20px;text-align:center;font-weight:bold;z-index:10;">0</span>
</div>

</div> <!-- إغلاق الحاوي الرئيسي -->
<!-- CSS للوضع الليلي -->
<style>
body.dark, #main-wrapper.dark {
    background: #181824 !important;
    color: #e0e0e0 !important;
}
.dark .bg-white, .dark .card, .dark .rounded-xl, .dark .border, .dark .container, .dark .shadow-sm, .dark .shadow-md {
    background: #232336 !important;
    color: #e0e0e0 !important;
}
.dark .table, .dark .table-striped, .dark th, .dark td {
    background: #232336 !important;
    color: #e0e0e0 !important;
    border-color: #33334d !important;
}
.dark .alert, .dark .bg-red-50, .dark .border-red-500 {
    background: #2a2a40 !important;
    color: #ffb3b3 !important;
    border-color: #ff4d4d !important;
}
.dark .bg-blue-600, .dark .bg-yellow-600, .dark .bg-red-500, .dark .bg-green-500, .dark .bg-teal-500, .dark .bg-purple-600, .dark .bg-gray-800, .dark .bg-indigo-600, .dark .bg-green-800, .dark .bg-yellow-800, .dark .bg-red-700, .dark .bg-teal-700 {
    filter: brightness(0.85) contrast(1.1);
}
.dark .text-blue-600, .dark .text-green-600, .dark .text-yellow-600, .dark .text-red-600, .dark .text-purple-600, .dark .text-teal-600, .dark .text-indigo-600 {
    color: #90caf9 !important;
}
.dark .text-gray-500, .dark .text-gray-700 {
    color: #b0b0b0 !important;
}
.dark .text-xs, .dark .text-sm {
    color: #b0b0b0 !important;
}
.dark .text-blue-900, .dark .text-gray-900, .dark .font-bold, .dark h1, .dark h2, .dark h3, .dark h4, .dark h5 {
    color: #e0e0e0 !important;
}
.dark .btn, .dark .btn-outline-dark, .dark .btn-outline-primary, .dark .btn-outline-success, .dark .btn-outline-warning, .dark .btn-outline-danger {
    background: #232336 !important;
    color: #e0e0e0 !important;
    border-color: #e0e0e0 !important;
}
.dark .btn:hover, .dark .btn-outline-dark:hover {
    background: #33334d !important;
    color: #fff !important;
}
.dark input, .dark select, .dark textarea {
    background: #232336 !important;
    color: #e0e0e0 !important;
    border-color: #33334d !important;
}
.dark .bg-gradient-to-br, .dark .bg-gradient-to-r {
    background: linear-gradient(135deg, #232336 0%, #181824 100%) !important;
}
.dark .rounded-xl, .dark .rounded-lg {
    box-shadow: none !important;
}
.dark .badge, .dark .rounded-full {
    background: #33334d !important;
    color: #e0e0e0 !important;
}
.dark .hover\:bg-gray-50:hover {
    background: #232336 !important;
}
.dark .border {
    border-color: #33334d !important;
}
</style>

<!-- جافاسكريبت لتبديل الوضع الليلي وحفظ التفضيل -->
<script>
function setDarkMode(enabled) {
    document.body.classList.toggle('dark', enabled);
    document.getElementById('main-wrapper').classList.toggle('dark', enabled);
    document.getElementById('dark-mode-icon').textContent = enabled ? '☀️' : '🌙';
    localStorage.setItem('darkMode', enabled ? '1' : '0');
}
document.getElementById('toggle-dark-mode').addEventListener('click', function() {
    const isDark = document.body.classList.contains('dark');
    setDarkMode(!isDark);
});
document.addEventListener('DOMContentLoaded', function() {
    if (localStorage.getItem('darkMode') === '1') {
        setDarkMode(true);
    }
});
</script>

<!-- 🆕 JavaScript للميزات المتقدمة -->
<script>
// إدارة تثبيت PWA
let deferredPrompt;
const installButton = document.getElementById('installPWA');

window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installButton.style.display = 'flex';
});

installButton.addEventListener('click', async () => {
    if (deferredPrompt) {
        deferredPrompt.prompt();
        const { outcome } = await deferredPrompt.userChoice;
        if (outcome === 'accepted') {
            console.log('تم تثبيت التطبيق');
        }
        deferredPrompt = null;
        installButton.style.display = 'none';
    }
});

// طلب إذن الإشعارات
function requestNotificationPermission() {
    if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                new Notification('🎉 تم تفعيل الإشعارات!', {
                    body: 'ستتلقى إشعارات عن التحديثات والأنشطة المهمة.',
                    icon: '{% static "logo.png" %}',
                    tag: 'welcome'
                });
                
                // تسجيل للإشعارات المدفوعة
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.ready.then(registration => {
                        return registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: 'YOUR_VAPID_PUBLIC_KEY'
                        });
                    }).then(subscription => {
                        // إرسال الاشتراك للخادم
                        console.log('تم تسجيل الإشعارات المدفوعة:', subscription);
                    });
                }
            } else {
                alert('⚠️ تم رفض إذن الإشعارات. يمكنك تفعيلها من إعدادات المتصفح.');
            }
        });
    } else {
        alert('❌ متصفحك لا يدعم الإشعارات.');
    }
}

// تحديث الإحصائيات في الوقت الفعلي
function updateRealTimeStats() {
    fetch('/api/stats/realtime/')
        .then(response => response.json())
        .then data => {
            // تحديث عدد سجلات التدقيق
            const auditElement = document.querySelector('[data-stat="audit_logs"]');
            if (auditElement && data.audit_logs !== undefined) {
                auditElement.textContent = data.audit_logs;
            }
            
            // تحديث التنبيهات الأمنية
            const alertsElement = document.querySelector('[data-stat="security_alerts"]');
            if (alertsElement && data.security_alerts !== undefined) {
                alertsElement.textContent = data.security_alerts;
            }
            
            // إظهار تنبيه جديد إذا كان هناك تنبيه أمني جديد
            if (data.new_security_alert) {
                showSecurityAlert(data.new_security_alert);
            }
        })
        .catch(error => console.log('خطأ في تحديث الإحصائيات:', error));
}

// إظهار تنبيه أمني جديد
function showSecurityAlert(alert) {
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('🚨 تنبيه أمني جديد!', {
            body: alert.description,
            icon: '{% static "logo.png" %}',
            tag: 'security-alert',
            requireInteraction: true
        });
    }
    
    // إضافة تنبيه مرئي في الصفحة
    const alertDiv = document.createElement('div');
    alertDiv.className = 'fixed top-4 right-4 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded shadow-lg z-50';
    alertDiv.innerHTML = `
        <div class="flex items-center">
            <span class="text-lg mr-2">🚨</span>
            <div>
                <strong>تنبيه أمني جديد!</strong>
                <p class="text-sm">${alert.description}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-red-500 hover:text-red-700">&times;</button>
        </div>
    `;
    document.body.appendChild(alertDiv);
    
    // إزالة التنبيه تلقائياً بعد 10 ثوان
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.remove();
        }
    }, 10000);
}

// تحديث الإحصائيات كل 30 ثانية
setInterval(updateRealTimeStats, 30000);

// تحديث أولي عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', updateRealTimeStats);

// تحديث عدد الإشعارات
function updateNotificationCount() {
    fetch('/notifications/count/')
        .then(response => response.json())
        .then(data => {
            const badge = document.getElementById('notification-badge');
            if (badge) {
                if (data.count > 0) {
                    badge.textContent = data.count > 99 ? '99+' : data.count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        })
        .catch(error => console.error('Error fetching notification count:', error));
}
document.addEventListener('DOMContentLoaded', function() {
    updateNotificationCount();
    setInterval(updateNotificationCount, 60000);
});
</script>

{% endblock %}
